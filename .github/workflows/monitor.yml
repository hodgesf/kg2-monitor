name: KG2 Monitor + Pages Deploy

on:
  schedule:
    - cron: "*/5 * * * *"   # every 5 minutes
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check KG2 health
        run: |
          HOST="kg2cplover3.rtx.ai"
          HEALTH_URL="https://$HOST:9990/healthcheck"
          LOGS_URL="https://$HOST:9990/logs?num_lines=100"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          HTTP_CODE=$(curl -k -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo 000)

          STATUS="up"
          ERROR=""
          LOGS=null

          if [ "$HTTP_CODE" != "200" ]; then
            STATUS="down"
            ERROR="healthcheck_failed"
            LOGS=$(curl -k -s "$LOGS_URL" || echo "{}")
          fi

          mkdir -p docs

          jq -n \
            --arg host "$HOST" \
            --arg status "$STATUS" \
            --arg time "$TIMESTAMP" \
            --arg error "$ERROR" \
            --argjson logs "$LOGS" \
            '{
              host: $host,
              status: $status,
              last_checked: $time,
              error: ($error | select(length > 0)),
              logs: (if $status == "down" then $logs else null end)
            }' > docs/status.json

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
