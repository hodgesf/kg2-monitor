name: KG2 Monitor + Pages Deploy

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Probe KG2 service
        run: |
          HOST="kg2cplover3.rtx.ai"
          SERVICE_URL="https://$HOST"
          LOGS_URL="https://$HOST:9990/logs?num_lines=100"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          START=$(date +%s%3N)

          HTTP_CODE=$(curl -k -sS -o /dev/null \
            -w "%{http_code}" \
            --connect-timeout 10 \
            --max-time 20 \
            "$SERVICE_URL" || echo "000")

          END=$(date +%s%3N)
          LATENCY_MS=$((END - START))

          STATUS="up"
          ERROR=null
          LOGS=null

          if [ "$HTTP_CODE" != "200" ]; then
            STATUS="down"

            if [ "$HTTP_CODE" = "000" ]; then
              ERROR="network_or_timeout"
            elif [[ "$HTTP_CODE" =~ ^5 ]]; then
              ERROR="backend_or_gateway_failure"
            elif [[ "$HTTP_CODE" =~ ^4 ]]; then
              ERROR="client_or_auth_error"
            else
              ERROR="unknown_http_error"
            fi

            LOGS=$(curl -k -sS --max-time 10 "$LOGS_URL" || echo "{}")
          fi

          mkdir -p docs

          jq -n \
            --arg host "$HOST" \
            --arg url "$SERVICE_URL" \
            --arg status "$STATUS" \
            --arg http_code "$HTTP_CODE" \
            --arg latency "$LATENCY_MS" \
            --arg time "$TIMESTAMP" \
            --arg error "$ERROR" \
            --argjson logs "$LOGS" \
            '{
              host: $host,
              url: $url,
              status: $status,
              http_code: ($http_code | tonumber),
              latency_ms: ($latency | tonumber),
              last_checked: $time,
              error: ($error | select(. != "null")),
              logs: (if $status == "down" then $logs else null end)
            }' > docs/status.json

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
