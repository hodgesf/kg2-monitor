name: KG2 External Monitor

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Probe KG2 service
        run: |
          SERVICE_URL="https://kg2cplover3.rtx.ai"
          LOGS_URL="https://kg2cplover3.rtx.ai:9990/logs?num_lines=100"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          START=$(date +%s%3N)

          HTTP_CODE=$(curl -sS -o response_body.txt \
            -w "%{http_code}" \
            --connect-timeout 10 \
            --max-time 20 \
            "$SERVICE_URL" || echo "000")

          END=$(date +%s%3N)
          LATENCY_MS=$((END - START))

          STATUS="up"
          ERROR=""
          LOGS=null

          if [ "$HTTP_CODE" != "200" ]; then
            STATUS="down"

            if [ "$HTTP_CODE" = "000" ]; then
              ERROR="network_or_timeout"
            elif [[ "$HTTP_CODE" =~ ^5 ]]; then
              ERROR="backend_or_gateway_failure"
            elif [[ "$HTTP_CODE" =~ ^4 ]]; then
              ERROR="client_or_auth_error"
            else
              ERROR="unknown_http_error"
            fi

            LOGS=$(curl -sS --max-time 10 "$LOGS_URL" || echo "{}")
          fi

          jq -n \
            --arg url "$SERVICE_URL" \
            --arg status "$STATUS" \
            --arg http_code "$HTTP_CODE" \
            --arg latency "$LATENCY_MS" \
            --arg time "$TIMESTAMP" \
            --arg error "$ERROR" \
            --argjson logs "$LOGS" \
            '{
              host: ($url | sub("^https?://"; "")),
              url: $url,
              status: $status,
              http_code: ($http_code | tonumber),
              latency_ms: ($latency | tonumber),
              last_checked: $time,
              error: ($error | select(length > 0)),
              logs: (if $status == "down" then $logs else null end)
            }' > status.json

      - name: Commit status update
        run: |
          git config user.name "kg2-monitor-bot"
          git config user.email "actions@github.com"
          git add status.json
          git commit -m "KG2 status: $(jq -r .status status.json)" || exit 0
          git push
