name: KG2 Monitor + Pages Deploy

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq and curl
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Run healthcheck and build status
        shell: bash
        run: |
          set -euo pipefail

          HOST="kg2cplover3.rtx.ai"
          BASE_URL="https://hodgesf.github.io/kg2-monitor"
          HEALTH_URL="https://$HOST:9990/healthcheck"
          LOGS_URL="https://$HOST:9990/logs?num_lines=100"

          NOW_EPOCH=$(date -u +%s)
          NOW_ISO=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          START=$(date +%s%3N)
          HTTP_CODE=$(curl -k -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo 000)
          END=$(date +%s%3N)
          LATENCY_MS=$((END - START))

          STATUS="up"
          ERROR=""
          LOGS=""

          if [ "$HTTP_CODE" != "200" ]; then
            STATUS="down"
            ERROR="healthcheck_failed"
            LOGS=$(curl -k -s "$LOGS_URL" || echo "{}")
          fi

          PREV_JSON=$(curl -s "$BASE_URL/status.json" || echo "")

          if [ -z "$PREV_JSON" ]; then
            PREV_JSON='{}'
          fi

          PREV_STATUS=$(echo "$PREV_JSON" | jq -r '.status // "unknown"' 2>/dev/null || echo "unknown")
          PREV_UP_SINCE=$(echo "$PREV_JSON" | jq -r '.up_since // empty' 2>/dev/null || echo "")
          PREV_LAST_CRASH=$(echo "$PREV_JSON" | jq -r '.last_crash // empty' 2>/dev/null || echo "")

          if [ "$STATUS" = "up" ]; then
            if [ "$PREV_STATUS" = "up" ] && [ -n "$PREV_UP_SINCE" ]; then
              UP_SINCE="$PREV_UP_SINCE"
            else
              UP_SINCE="$NOW_ISO"
            fi
            LAST_CRASH="$PREV_LAST_CRASH"
          else
            UP_SINCE=""
            LAST_CRASH="$NOW_ISO"
          fi

          if [ "$STATUS" = "up" ] && [ -n "$UP_SINCE" ]; then
            UP_EPOCH=$(date -d "$UP_SINCE" +%s)
            UPTIME_SECONDS=$((NOW_EPOCH - UP_EPOCH))
          else
            UPTIME_SECONDS=0
          fi

          mkdir -p docs

          jq -n \
            --arg host "$HOST" \
            --arg status "$STATUS" \
            --arg time "$NOW_ISO" \
            --argjson http_code "$HTTP_CODE" \
            --argjson latency_ms "$LATENCY_MS" \
            --argjson uptime_seconds "$UPTIME_SECONDS" \
            --arg up_since "$UP_SINCE" \
            --arg last_crash "$LAST_CRASH" \
            --arg error "$ERROR" \
            --arg logs_raw "$LOGS" \
            '
            {
              host: $host,
              status: $status,
              last_checked: $time,
              http_code: $http_code,
              latency_ms: $latency_ms,
              uptime_seconds: $uptime_seconds,
              up_since: ($up_since | select(. != "")),
              last_crash: ($last_crash | select(. != "")),
              error: (if $status == "down" then $error else null end),
              logs: (
                if $status == "down"
                then $logs_raw | fromjson?
                else null
                end
              )
            }
            ' > docs/status.json

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
