name: KG2 Monitor + Pages Deploy

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq and curl
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Run healthcheck and build status
        shell: bash
        run: |
          set -euo pipefail

          HOST="kg2cplover3.rtx.ai"
          BASE_URL="https://hodgesf.github.io/kg2-monitor"
          HEALTH_URL="https://$HOST:9990/healthcheck"
          LOGS_URL="https://$HOST:9990/logs"

          NOW_EPOCH=$(date -u +%s)
          NOW_ISO=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          START=$(date +%s%3N)
          HTTP_CODE=$(curl -k -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo 000)
          END=$(date +%s%3N)
          LATENCY_MS=$((END - START))

          STATUS="up"
          ERROR=""
          LOGS=""

          if [ "$HTTP_CODE" != "200" ]; then
            STATUS="down"
            ERROR="healthcheck_failed"
            LOGS=$(curl -k -s "$LOGS_URL" || echo "{}")
          fi

          # --- Robust previous state fetch ---
          PREV_JSON=$(curl -f -s "$BASE_URL/status.json" || echo "{}")
          if ! echo "$PREV_JSON" | jq . >/dev/null 2>&1; then
            PREV_JSON='{}'
          fi

          PREV_STATUS=$(echo "$PREV_JSON" | jq -r '.status // "unknown"')
          PREV_UP_SINCE=$(echo "$PREV_JSON" | jq -r '.up_since // empty')
          PREV_LAST_CRASH=$(echo "$PREV_JSON" | jq -r '.last_crash // empty')

          if [ "$STATUS" = "up" ]; then
            if [ "$PREV_STATUS" = "up" ] && [ -n "$PREV_UP_SINCE" ]; then
              UP_SINCE="$PREV_UP_SINCE"
            else
              UP_SINCE="$NOW_ISO"
            fi
            LAST_CRASH="$PREV_LAST_CRASH"
          else
            UP_SINCE=""
            LAST_CRASH="$NOW_ISO"
          fi

          if [ "$STATUS" = "up" ] && [ -n "$UP_SINCE" ]; then
            UP_EPOCH=$(date -d "$UP_SINCE" +%s)
            UPTIME_SECONDS=$((NOW_EPOCH - UP_EPOCH))
          else
            UPTIME_SECONDS=0
          fi

          mkdir -p docs

          # --- Guaranteed baseline ---
          cat > docs/status.json <<EOF
          {
            "host": "$HOST",
            "status": "$STATUS",
            "last_checked": "$NOW_ISO",
            "http_code": $HTTP_CODE,
            "latency_ms": $LATENCY_MS,
            "uptime_seconds": $UPTIME_SECONDS
          }
          EOF

          # --- Build enriched JSON safely ---
          FINAL_JSON=$(jq -n \
            --arg host "$HOST" \
            --arg status "$STATUS" \
            --arg time "$NOW_ISO" \
            --argjson http_code "$HTTP_CODE" \
            --argjson latency_ms "$LATENCY_MS" \
            --argjson uptime_seconds "$UPTIME_SECONDS" \
            --arg up_since "$UP_SINCE" \
            --arg last_crash "$LAST_CRASH" \
            --arg error "$ERROR" \
            --arg logs_raw "$LOGS" \
            '
            {
              host: $host,
              status: $status,
              last_checked: $time,
              http_code: $http_code,
              latency_ms: $latency_ms,
              uptime_seconds: $uptime_seconds,
              up_since: (if $up_since != "" then $up_since else null end),
              last_crash: (if $last_crash != "" then $last_crash else null end),
              error: (if $status == "down" then $error else null end),
              logs: (
                if $status == "down"
                then ($logs_raw | fromjson? // $logs_raw)
                else null
                end
              )
            }
            ')

          if [ -n "$FINAL_JSON" ]; then
            echo "$FINAL_JSON" > docs/status.json
          else
            echo "jq produced no output; keeping baseline" >&2
          fi

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
